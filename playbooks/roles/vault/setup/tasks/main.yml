- name: Create vault group
  group:
    name: vault
    state: present

- name: Create vault user
  user:
    name: vault
    group: vault
    system: yes
    shell: "/sbin/nologin"
    createhome: no
    state: present

################################################################################

- name: Download Vault (amd64)
  when: ansible_architecture == "x86_64"
  unarchive:
    remote_src: true
    src: https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ nomad_version }}_linux_amd64.zip
    dest: /opt/vault
    owner: vault
    group: vault

- name: Download Vault (arm)
  when: ansible_architecture == "armv7l"
  unarchive:
    remote_src: true
    src: https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ nomad_version }}_linux_arm.zip
    dest: /opt/vault
    owner: vault
    group: vault

- name: Download Vault (arm64)
  when: ansible_architecture == "aarch64"
  unarchive:
    remote_src: true
    src: https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ nomad_version }}_linux_arm64.zip
    dest: /opt/vault
    owner: vault
    group: vault

- name: Set Vault binary capabilities
  capabilities:
    path: /opt/vault
    capability: cap_ipc_lock+ep
    state: present
